
#!/usr/bin/env bash
echo "******* Start pre-deploy **************************************************"
set -e

# bin/update-npm
npm --registry=http://r.npm.sankuai.com --cache=$HOME/.npm/.cache/mnpm --userconfig=$HOME/.mnpmrc install

npm_config_registry=http://r.npm.sankuai.com ./node_modules/pm2/bin/pm2 install pm2-logrotate
./node_modules/pm2/bin/pm2 set pm2-logrotate:max_size 2M
./node_modules/pm2/bin/pm2 set pm2-logrotate:retain 30

# 动态注入ERA环境变量 ERA_NODE_ENV NODE_ENV
export ERA_NODE_ENV=test
export NODE_ENV=test

# 编译打包静态资源
npm run build

# 创建压缩包 static
tar -czf update.tar.gz static

# 上传压缩包给Build Service

echo "******* Finish pre-deploy ********************************************************"
            